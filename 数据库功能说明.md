# æ•°æ®åº“åŠŸèƒ½è¯´æ˜

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

ç³»ç»Ÿç°åœ¨æ”¯æŒå°†å®¡è®¡è®°å½•ä¿å­˜åˆ° MySQL æ•°æ®åº“ï¼Œå¹¶æä¾›å†å²è®°å½•æŸ¥è¯¢åŠŸèƒ½ã€‚

## ğŸ“‹ æ•°æ®åº“è¡¨ç»“æ„

### audit_history è¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| id | INT | ä¸»é”®ï¼Œè‡ªå¢ |
| code | TEXT | è¾“å…¥çš„ Rust ä»£ç  |
| result | TEXT | å®¡è®¡æŠ¥å‘Šç»“æœ |
| code_length | INT | ä»£ç é•¿åº¦ |
| result_length | INT | æŠ¥å‘Šé•¿åº¦ |
| inference_time | FLOAT | æ¨ç†è€—æ—¶ï¼ˆç§’ï¼‰ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ |

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å‡†å¤‡æ•°æ®åº“

ç¡®ä¿ MySQL æœåŠ¡æ­£åœ¨è¿è¡Œï¼Œå¹¶åˆ›å»ºæ•°æ®åº“ï¼š

```sql
CREATE DATABASE rustsentinel CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 2. é…ç½®æ•°æ®åº“è¿æ¥

ç¼–è¾‘ `simple_server_with_db.py` ä¸­çš„æ•°æ®åº“é…ç½®ï¼š

```python
DB_CONFIG = {
    'host': '127.0.0.1',
    'user': 'root',
    'password': '123456',  # ä¿®æ”¹ä¸ºä½ çš„å¯†ç 
    'database': 'rustsentinel',
    'port': 3306
}
```

### 3. å¯åŠ¨æœåŠ¡

```bash
start_server_with_db.bat
```

æœåŠ¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„ã€‚

### 4. ä½¿ç”¨å‰ç«¯

- **å®¡è®¡é¡µé¢**: http://localhost:3000
  - è¾“å…¥ä»£ç ï¼Œç‚¹å‡»å®¡è®¡
  - å®¡è®¡ç»“æœä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“

- **å†å²è®°å½•é¡µé¢**: http://localhost:3000/history
  - æŸ¥çœ‹æ‰€æœ‰å®¡è®¡å†å²
  - æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
  - åˆ é™¤è®°å½•

## ğŸ“Š API æ¥å£

### 1. è·å–å†å²è®°å½•åˆ—è¡¨

```
GET /api/history?page=1&page_size=10
```

**å“åº”**:
```json
{
  "total": 100,
  "page": 1,
  "page_size": 10,
  "records": [
    {
      "id": 1,
      "code": "fn main() { ... }",
      "result": "å®¡è®¡æŠ¥å‘Š...",
      "code_length": 100,
      "result_length": 500,
      "inference_time": 108.5,
      "created_at": "2026-01-11T08:00:00"
    }
  ]
}
```

### 2. è·å–å•æ¡è®°å½•è¯¦æƒ…

```
GET /api/history/{id}
```

### 3. åˆ é™¤è®°å½•

```
DELETE /api/history/{id}
```

### 4. å®¡è®¡æ¥å£ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰

```
POST /v1/chat/completions
```

å®¡è®¡å®Œæˆåä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ã€‚

## ğŸ¨ å‰ç«¯åŠŸèƒ½

### å†å²è®°å½•é¡µé¢

- âœ… åˆ†é¡µæ˜¾ç¤ºå†å²è®°å½•
- âœ… æ˜¾ç¤ºå®¡è®¡æ—¶é—´ã€æ¨ç†æ—¶é—´
- âœ… ä»£ç é¢„è§ˆï¼ˆå‰ä¸¤è¡Œï¼‰
- âœ… æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼ˆæ¨¡æ€æ¡†ï¼‰
- âœ… åˆ é™¤è®°å½•
- âœ… å“åº”å¼è®¾è®¡

### å®¡è®¡é¡µé¢

- âœ… è‡ªåŠ¨ä¿å­˜å®¡è®¡ç»“æœ
- âœ… æ— éœ€æ‰‹åŠ¨æ“ä½œ
- âœ… ä¿å­˜æˆåŠŸååœ¨æ§åˆ¶å°æ˜¾ç¤º

## ğŸ”§ é…ç½®é€‰é¡¹

### ä¿®æ”¹åˆ†é¡µå¤§å°

ç¼–è¾‘ `RustSentinelFrontend/app/history/page.tsx`:

```typescript
const [pageSize] = useState(10);  // æ”¹ä¸ºå…¶ä»–æ•°å­—
```

### ä¿®æ”¹æ•°æ®åº“é…ç½®

ç¼–è¾‘ `simple_server_with_db.py`:

```python
DB_CONFIG = {
    'host': '127.0.0.1',      # æ•°æ®åº“åœ°å€
    'user': 'root',           # ç”¨æˆ·å
    'password': '123456',     # å¯†ç 
    'database': 'rustsentinel',  # æ•°æ®åº“å
    'port': 3306              # ç«¯å£
}
```

## ğŸ“Š æ•°æ®ç»Ÿè®¡

### æŸ¥è¯¢æ€»å®¡è®¡æ¬¡æ•°

```sql
SELECT COUNT(*) FROM audit_history;
```

### æŸ¥è¯¢å¹³å‡æ¨ç†æ—¶é—´

```sql
SELECT AVG(inference_time) FROM audit_history;
```

### æŸ¥è¯¢æœ€è¿‘çš„å®¡è®¡

```sql
SELECT * FROM audit_history 
ORDER BY created_at DESC 
LIMIT 10;
```

### æŒ‰æ—¥æœŸç»Ÿè®¡

```sql
SELECT DATE(created_at) as date, COUNT(*) as count
FROM audit_history
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æ•°æ®åº“è¿æ¥å¤±è´¥

**é”™è¯¯**: `Can't connect to MySQL server`

**è§£å†³**:
1. ç¡®ä¿ MySQL æœåŠ¡æ­£åœ¨è¿è¡Œ
2. æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç 
3. ç¡®ä¿æ•°æ®åº“ `rustsentinel` å·²åˆ›å»º

### Q2: è¡¨ä¸å­˜åœ¨

**é”™è¯¯**: `Table 'rustsentinel.audit_history' doesn't exist`

**è§£å†³**:
é‡å¯æœåŠ¡ï¼Œè¡¨ä¼šè‡ªåŠ¨åˆ›å»ºã€‚æˆ–æ‰‹åŠ¨æ‰§è¡Œï¼š

```sql
CREATE TABLE audit_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    code TEXT NOT NULL,
    result TEXT NOT NULL,
    code_length INT,
    result_length INT,
    inference_time FLOAT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### Q3: ä¸­æ–‡ä¹±ç 

**è§£å†³**:
ç¡®ä¿æ•°æ®åº“å’Œè¡¨ä½¿ç”¨ utf8mb4 å­—ç¬¦é›†ï¼š

```sql
ALTER DATABASE rustsentinel CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
ALTER TABLE audit_history CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### Q4: å†å²è®°å½•é¡µé¢ç©ºç™½

**è§£å†³**:
1. æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨
2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
3. ç¡®è®¤ API åœ°å€æ­£ç¡®ï¼ˆhttp://localhost:8000ï¼‰

## ğŸ¯ ä½¿ç”¨å»ºè®®

### æ•°æ®å¤‡ä»½

å®šæœŸå¤‡ä»½æ•°æ®åº“ï¼š

```bash
mysqldump -u root -p rustsentinel > backup.sql
```

### æ•°æ®æ¸…ç†

åˆ é™¤æ—§è®°å½•ï¼š

```sql
DELETE FROM audit_history 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### æ€§èƒ½ä¼˜åŒ–

å¦‚æœè®°å½•å¾ˆå¤šï¼Œå¯ä»¥æ·»åŠ ç´¢å¼•ï¼š

```sql
CREATE INDEX idx_inference_time ON audit_history(inference_time);
CREATE INDEX idx_code_length ON audit_history(code_length);
```

## ğŸ“ ç‰ˆæœ¬å¯¹æ¯”

| ç‰ˆæœ¬ | å¯åŠ¨è„šæœ¬ | æ•°æ®åº“æ”¯æŒ |
|-----|---------|-----------|
| åŸç‰ˆ | `start_optimized_server.bat` | âŒ å¦ |
| **æ•°æ®åº“ç‰ˆ** | **`start_server_with_db.bat`** | **âœ… æ˜¯** |
| Ollama ç‰ˆ | `start_simple_server_ollama.bat` | âŒ å¦ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# 1. ç¡®ä¿ MySQL è¿è¡Œå¹¶åˆ›å»ºæ•°æ®åº“
mysql -u root -p
CREATE DATABASE rustsentinel;
exit

# 2. å¯åŠ¨åç«¯ï¼ˆå¸¦æ•°æ®åº“ï¼‰
cd httpsgithub.comXcoconut114514RustSentinel-of-ShanghaiOpen
start_server_with_db.bat

# 3. å¯åŠ¨å‰ç«¯
cd RustSentinelFrontend
npm run dev

# 4. è®¿é—®
# å®¡è®¡: http://localhost:3000
# å†å²: http://localhost:3000/history
```

---

**æ€»ç»“**: ç°åœ¨ç³»ç»Ÿæ”¯æŒå®Œæ•´çš„å®¡è®¡å†å²è®°å½•åŠŸèƒ½ï¼Œæ‰€æœ‰å®¡è®¡ç»“æœéƒ½ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå¯ä»¥éšæ—¶æŸ¥çœ‹å’Œç®¡ç†å†å²è®°å½•ã€‚
